name: Smoke Test

on: [push]

defaults:
  run:
    shell: bash
    working-directory: ./

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Install & Checkhealth (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: ./scripts/install.sh

      - name: Add Homebrew to PATH
        run: |
          echo "Adding Homebrew bin to PATH"
          if [[ $(uname) == "Darwin" ]]; then
            echo "/opt/homebrew/bin" >> $GITHUB_PATH
          else
            echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
          fi

      - name: Lazy Install
        run: git clone --filter=blob:none --branch=stable https://github.com/folke/lazy.nvim.git ~/.local/share/nvim/lazy/lazy.nvim

      - name: Neovim Lazy Plugin Sync
        run: nvim --headless "+Lazy! sync" +qa

      - name: Neovim Checkhealth
        run: |
          export TERM=xterm-256color
          nvim --headless "+checkhealth | redir => out | silent messages | redir END | w! checkhealth.log | q"
          cat checkhealth.log

      - name: Fail on Neovim Health Error
        run: |
          # Filter out errors from disabled plugin features
          # Only report errors from enabled features
          errors=$(awk '
            /^[A-Za-z]/ { current_section = $1; disabled = 0 }
            /WARNING setup {disabled}/ { disabled = 1 }
            /ERROR/ { 
              if (!disabled) {
                print current_section ": " $0
              }
            }
          ' checkhealth.log)
          
          if [ -n "$errors" ]; then
            echo "::error::Neovim checkhealth found errors in enabled features:"
            echo "$errors"
            exit 1
          fi
          echo "âœ… No critical errors found in checkhealth"
