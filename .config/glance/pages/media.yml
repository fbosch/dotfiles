- name: Media
  columns:
    - size: small
      widgets:
        - type: monitor
          cache: 1m
          title: Media Services
          sites:
            - title: Radarr
              url: https://radarr.corvus-corax.synology.me
              icon: sh:radarr-light
            - title: Sonarr
              url: https://sonarr.corvus-corax.synology.me
              icon: sh:sonarr-light
            - title: Prowlarr
              url: https://prowlarr.corvus-corax.synology.me
              icon: sh:prowlarr-light
            - title: Bazarr
              url: https://bazarr.corvus-corax.synology.me
              icon: sh:bazarr-light
            - title: rdtclient
              url: https://rdtclient.corvus-corax.synology.me
              icon: si:docker
            - title: Plex
              url: https://plex.corvus-corax.synology.me/web/index.html#!/
              icon: sh:plex-light
    - size: full
      widgets:
        - type: custom-api
          title: Real-Debrid
          cache: 30s
          url: https://api.real-debrid.com/rest/1.0/user
          headers:
            Authorization: Bearer ${RD_API_KEY}
            Accept: application/json
          subrequests:
            active:
              url: https://api.real-debrid.com/rest/1.0/torrents
              headers:
                Authorization: Bearer ${RD_API_KEY}
                Accept: application/json
              parameters:
                filter: active
                limit: 10
          template: |
            {{ $active := .Subrequest "active" }}
            {{ if and (eq .Response.StatusCode 200) (eq $active.Response.StatusCode 200) }}
              {{ $premiumSeconds := .JSON.Int "premium" }}
              {{ $days := div $premiumSeconds 86400 }}
              {{ $hours := div (mod $premiumSeconds 86400) 3600 }}
              {{ $activeList := $active.JSON.Array "" }}

              <div class="flex justify-between text-center" style="margin-bottom: 1rem;">
                <div>
                  <div class="color-highlight size-h3">{{ len $activeList }}</div>
                  <div class="size-h6">ACTIVE</div>
                </div>
                <div>
                  <div class="color-highlight size-h3">{{ $days }}d {{ $hours }}h</div>
                  <div class="size-h6">PREMIUM LEFT</div>
                </div>
                <div>
                  <div class="color-highlight size-h3">{{ .JSON.String "type" }}</div>
                  <div class="size-h6">ACCOUNT</div>
                </div>
              </div>

              {{ if eq (len $activeList) 0 }}
                <p>No active downloads.</p>
              {{ else }}
                <ul class="list list-gap-12">
                  {{ range $activeList }}
                    {{ $progress := .Int "progress" }}
                    <li>
                      <div class="flex justify-between items-center gap-10">
                        <div class="text-truncate color-highlight" style="max-width: 70%;">{{ .String "filename" }}</div>
                        <div class="size-h6">{{ $progress }}%</div>
                      </div>
                      <div style="background: rgba(128, 128, 128, 0.2); border-radius: 5px; height: 6px; margin-top: 6px; overflow: hidden;">
                        <div style="width: {{ $progress }}%; background-color: var(--color-positive); height: 100%; border-radius: 5px;"></div>
                      </div>
                      <div class="flex justify-between size-h6 color-paragraph" style="margin-top: 4px;">
                        <span>{{ .String "status" }}</span>
                        {{ $speed := .Int "speed" }}
                        {{ if gt $speed 0 }}
                          <span>{{ printf "%.1f MB/s" (div (.Float "speed") 1000000.0) }}</span>
                        {{ else }}
                          <span>--</span>
                        {{ end }}
                      </div>
                    </li>
                  {{ end }}
                </ul>
              {{ end }}
            {{ else }}
              {{ if or (eq .Response.StatusCode 401) (eq .Response.StatusCode 403) (eq $active.Response.StatusCode 401) (eq $active.Response.StatusCode 403) }}
                <p class="color-negative">Real-Debrid auth failed. Check RD_API_KEY.</p>
              {{ else if or (eq .Response.StatusCode 429) (eq $active.Response.StatusCode 429) }}
                <p class="color-negative">Real-Debrid rate limit reached (429).</p>
              {{ else }}
                <p class="color-negative">Failed to fetch Real-Debrid data.</p>
              {{ end }}
            {{ end }}
    - size: small
      widgets:
        - type: custom-api
          title: Prowlarr Indexers
          cache: 1m
          options:
            url: "https://prowlarr.corvus-corax.synology.me"
            base-url: "https://prowlarr.corvus-corax.synology.me"
            api-key: ${PROWLARR_API_KEY}
            collapse-after: 5
          template: |
            {{ $apiBaseUrl := .Options.StringOr "base-url" "" }}
            {{ $key := .Options.StringOr "api-key" "" }}
            {{ $url := .Options.StringOr "url" "" }}
            {{ $collapseAfter := .Options.IntOr "collapse-after" 5 }}
            {{ if or (eq $apiBaseUrl "") (eq $key "") (eq $url "") }}
              <p class="color-negative">Set the Prowlarr API key in this widget options block.</p>
            {{ else }}
              {{ $indexData := newRequest (printf "%s/api/v1/indexer" $apiBaseUrl) | withHeader "Accept" "application/json" | withHeader "X-Api-Key" $key | getResponse }}
              {{ if eq $indexData.Response.StatusCode 200 }}
                <ul class="list list-gap-10 collapsible-container" data-collapse-after="{{ $collapseAfter }}">
                  {{ range $indexData.JSON.Array "" }}
                    <li class="flex items-center gap-10">
                      <a href="{{ $url }}" target="_blank" class="size-title-dynamic color-highlight text-truncate block grow">{{ .String "name" }}</a>
                      <span class="size-h6">{{ .String "privacy" }}</span>
                    </li>
                  {{ end }}
                </ul>
              {{ else }}
                <p class="color-negative">Failed to fetch Prowlarr indexers.</p>
              {{ end }}
            {{ end }}
