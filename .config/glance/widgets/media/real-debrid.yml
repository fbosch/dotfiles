- type: custom-api
  title: Real-Debrid
  title-url: https://real-debrid.com/torrents
  cache: 30s
  options:
    mock: "true"
    rd-api-key: ${RD_API_KEY}
  url: https://api.real-debrid.com/rest/1.0/user
  headers:
    Authorization: Bearer ${RD_API_KEY}
    Accept: application/json
  subrequests:
    active:
      url: https://api.real-debrid.com/rest/1.0/torrents
      headers:
        Authorization: Bearer ${RD_API_KEY}
        Accept: application/json
      parameters:
        filter: active
        limit: 10
  template: |
    {{ $mock := eq (.Options.StringOr "mock" "false") "false" }}
    {{ $active := .Subrequest "active" }}
    {{ $rdApiKey := "" }}
    {{ if not $mock }}
      {{ $rdApiKey = .Options.StringOr "rd-api-key" "" }}
    {{ end }}

    {{ if $mock }}
    <div data-rd-live data-rd-api-key="{{ $rdApiKey }}" data-rd-has-active="true">
      <div class="rd-summary">
        <div class="rd-stat">
          <div class="size-h5 color-subdue margin-bottom-3">Active</div>
          <div class="size-h3 color-highlight">4</div>
        </div>
        <div class="rd-stat">
          <div class="size-h5 color-subdue margin-bottom-3">Premium Left</div>
          <div class="size-h3 color-highlight">68d 4h</div>
        </div>
      </div>

      <ul class="list list-gap-14">
        <li class="rd-item">
          <div class="flex justify-between items-center gap-10 margin-bottom-7">
            <div class="size-title-dynamic color-primary text-truncate min-width-0">Silo.S02E03.2160p.WEB-DL.mkv</div>
            <span class="rd-state rd-state-active shrink-0"><span class="rd-state-dot"></span><span>Downloading</span></span>
          </div>
          <div class="progress-bar margin-bottom-7">
            <div class="progress-value" style="--percent: 82"></div>
          </div>
          <div class="flex justify-between items-center gap-10 size-h6 color-subdue">
            <span>82%</span><span>6.2 MB/s</span>
          </div>
        </li>

        <li class="rd-item">
          <div class="flex justify-between items-center gap-10 margin-bottom-7">
            <div class="size-title-dynamic color-primary text-truncate min-width-0">Dune.Part.Two.2024.1080p.BluRay.x265</div>
            <span class="rd-state rd-state-pending shrink-0"><span class="rd-state-dot"></span><span>Queued</span></span>
          </div>
          <div class="progress-bar margin-bottom-7">
            <div class="progress-value" style="--percent: 34"></div>
          </div>
          <div class="flex justify-between items-center gap-10 size-h6 color-subdue">
            <span>34%</span><span>--</span>
          </div>
        </li>

        <li class="rd-item">
          <div class="flex justify-between items-center gap-10 margin-bottom-7">
            <div class="size-title-dynamic color-primary text-truncate min-width-0">Severance.S01.COMPLETE.1080p</div>
            <span class="rd-state rd-state-active shrink-0"><span class="rd-state-dot"></span><span>Downloading</span></span>
          </div>
          <div class="progress-bar margin-bottom-7">
            <div class="progress-value" style="--percent: 61"></div>
          </div>
          <div class="flex justify-between items-center gap-10 size-h6 color-subdue">
            <span>61%</span><span>2.8 MB/s</span>
          </div>
        </li>

        <li class="rd-item">
          <div class="flex justify-between items-center gap-10 margin-bottom-7">
            <div class="size-title-dynamic color-primary text-truncate min-width-0">The.Last.of.Us.S02E01.4K</div>
            <span class="rd-state rd-state-magnet shrink-0"><span class="rd-state-dot"></span><span>Magnet</span></span>
          </div>
          <div class="progress-bar margin-bottom-7">
            <div class="progress-value" style="--percent: 9"></div>
          </div>
          <div class="flex justify-between items-center gap-10 size-h6 color-subdue">
            <span>9%</span><span>--</span>
          </div>
        </li>
      </ul>
    </div>
    {{ else if and (eq .Response.StatusCode 200) (eq $active.Response.StatusCode 200) }}
      {{ $premiumSeconds := .JSON.Int "premium" }}
      {{ $days := div $premiumSeconds 86400 }}
      {{ $hours := div (mod $premiumSeconds 86400) 3600 }}
      {{ $activeList := $active.JSON.Array "" }}
      {{ $hasActive := gt (len $activeList) 0 }}
    <div data-rd-live data-rd-api-key="{{ $rdApiKey }}" data-rd-has-active="{{ $hasActive }}">
      <div class="rd-summary">
        <div class="rd-stat">
          <div class="size-h5 color-subdue margin-bottom-3">Active</div>
          <div class="size-h3 color-highlight">{{ len $activeList }}</div>
        </div>
        <div class="rd-stat">
          <div class="size-h5 color-subdue margin-bottom-3">Premium Left</div>
          <div class="size-h3 color-highlight">{{ $days }}d {{ $hours }}h</div>
        </div>
      </div>

      {{ if eq (len $activeList) 0 }}
        <p>No active downloads.</p>
      {{ else }}
        <ul class="list list-gap-14">
          {{ range $activeList }}
            {{ $progress := .Int "progress" }}
            {{ $statusRaw := .String "status" }}
            {{ $statusText := "Unknown" }}
            {{ $statusClass := "pending" }}
            {{ if eq $statusRaw "downloading" }}
              {{ $statusText = "Downloading" }}
              {{ $statusClass = "active" }}
            {{ else if eq $statusRaw "queued" }}
              {{ $statusText = "Queued" }}
              {{ $statusClass = "pending" }}
            {{ else if eq $statusRaw "magnet_conversion" }}
              {{ $statusText = "Magnet" }}
              {{ $statusClass = "magnet" }}
            {{ else if eq $statusRaw "waiting_files_selection" }}
              {{ $statusText = "Selecting" }}
              {{ $statusClass = "waiting" }}
            {{ else if eq $statusRaw "compressing" }}
              {{ $statusText = "Compressing" }}
              {{ $statusClass = "compressing" }}
            {{ else if eq $statusRaw "uploading" }}
              {{ $statusText = "Uploading" }}
              {{ $statusClass = "uploading" }}
            {{ else if eq $statusRaw "downloaded" }}
              {{ $statusText = "Done" }}
              {{ $statusClass = "done" }}
            {{ else if or (eq $statusRaw "error") (eq $statusRaw "magnet_error") }}
              {{ $statusText = "Error" }}
              {{ $statusClass = "error" }}
            {{ else if eq $statusRaw "dead" }}
              {{ $statusText = "Dead" }}
              {{ $statusClass = "dead" }}
            {{ end }}
            <li class="rd-item">
              <div class="flex justify-between items-center gap-10 margin-bottom-7">
                <div class="size-title-dynamic color-primary text-truncate min-width-0">{{ .String "filename" }}</div>
                <span class="rd-state rd-state-{{ $statusClass }} shrink-0"><span class="rd-state-dot"></span><span>{{ $statusText }}</span></span>
              </div>
              <div class="progress-bar margin-bottom-7">
                <div class="progress-value" style="--percent: {{ $progress }}"></div>
              </div>
              <div class="flex justify-between items-center gap-10 size-h6 color-subdue">
                <span>{{ $progress }}%</span>
                {{ $speed := .Int "speed" }}
                {{ if gt $speed 0 }}
                  <span>{{ printf "%.1f MB/s" (div (.Float "speed") 1000000.0) }}</span>
                {{ else }}
                  <span>--</span>
                {{ end }}
              </div>
            </li>
          {{ end }}
        </ul>
      {{ end }}
    </div>
    {{ else }}
    <div data-rd-live data-rd-api-key="{{ $rdApiKey }}" data-rd-has-active="false">
      {{ if or (eq .Response.StatusCode 401) (eq .Response.StatusCode 403) (eq $active.Response.StatusCode 401) (eq $active.Response.StatusCode 403) }}
        <p class="color-negative">Real-Debrid auth failed. Check RD_API_KEY.</p>
      {{ else if or (eq .Response.StatusCode 429) (eq $active.Response.StatusCode 429) }}
        <p class="color-negative">Real-Debrid rate limit reached (429).</p>
      {{ else }}
        <p class="color-negative">Failed to fetch Real-Debrid data.</p>
      {{ end }}
    </div>
    {{ end }}
