- type: custom-api
  title: Plex Recently Added
  cache: 10m
  options:
    base-url: "https://plex.corvus-corax.synology.me"
    api-key: ${PLEX_TOKEN}
    machine-id: "527fd9cb40e644876667e21682d049ec24466835"
    limit: 10
    layout: vertical
  template: |
    {{ $baseURL := .Options.StringOr "base-url" "" }}
    {{ $apiKey := .Options.StringOr "api-key" "" }}
    {{ $machineId := .Options.StringOr "machine-id" "" }}
    {{ $layout := .Options.StringOr "layout" "vertical" }}
    {{ $defaultLimit := 6 }}
    {{ if eq $layout "horizontal" }}{{ $defaultLimit = 10 }}{{ end }}
    {{ $limit := .Options.IntOr "limit" $defaultLimit }}

    {{ if or (eq $baseURL "") (eq $apiKey "") (eq $machineId "") }}
      <p class="color-negative">Set Plex base URL, API token, and machine ID in this widget options block.</p>
    {{ else }}
      <link rel="stylesheet" href="/assets/css/plex.css">

      {{ $call := newRequest (concat $baseURL "/library/recentlyAdded")
        | withHeader "Accept" "application/json"
        | withHeader "X-Plex-Token" $apiKey
        | withParameter "X-Plex-Container-Start" "0"
        | withParameter "X-Plex-Container-Size" (printf "%d" $limit)
        | getResponse }}

      {{ if eq $call.Response.StatusCode 200 }}
        {{ $items := $call.JSON.Array "MediaContainer.Metadata" }}
        {{ if eq (len $items) 0 }}
          <p>No recent additions.</p>
        {{ else }}

          {{/* shared type-resolution helper */}}
          {{ if eq $layout "horizontal" }}

            <div class="carousel-container">
              <div class="cards-horizontal carousel-items-container" style="--cards-per-row: 6;">
                {{ range $items }}
                  {{ $itemType := .String "type" }}
                  {{ $typeClass := "item" }}
                  {{ if eq $itemType "movie" }}{{ $typeClass = "movie" }}
                  {{ else if eq $itemType "episode" }}{{ $typeClass = "episode" }}
                  {{ else if eq $itemType "season" }}{{ $typeClass = "season" }}
                  {{ else if eq $itemType "show" }}{{ $typeClass = "show" }}
                  {{ end }}

                  {{ $title := .String "title" }}
                  {{ if eq $itemType "episode" }}
                    {{ $title = concat (.String "grandparentTitle") " — " (.String "title") }}
                  {{ end }}

                  {{ $thumbPath := .String "thumb" }}
                  {{ if eq $itemType "episode" }}{{ $thumbPath = .String "grandparentThumb" }}{{ end }}
                  {{ $thumbURL := "" }}
                  {{ if ne $thumbPath "" }}
                    {{ $thumbURL = concat $baseURL $thumbPath "?X-Plex-Token=" $apiKey }}
                  {{ end }}

                  {{ $itemKey := .String "key" }}
                  {{ $itemURL := concat $baseURL "/web/index.html#!/server/" $machineId "/details?key=" $itemKey }}

                  {{ $addedAt := .String "addedAt" | parseRelativeTime "unix" }}

                  <a href="{{ $itemURL | safeURL }}" target="_blank" rel="noreferrer" class="card plex-card widget-content-frame">
                    {{ if ne $thumbURL "" }}
                      <img class="plex-card-image" src="{{ $thumbURL | safeURL }}" alt="{{ $title }} poster" loading="lazy" />
                    {{ end }}
                    <div class="plex-card-content padding-inline-widget">
                      <div class="color-highlight size-h5">
                        {{ $title }}
                      </div>
                      <div class="size-h6 color-paragraph margin-top-5">
                        {{ if gt (.Int "year") 0 }}{{ .Int "year" }} · {{ end }}<span {{ $addedAt }}></span> ago
                      </div>
                    </div>
                  </a>
                {{ end }}
              </div>
            </div>

          {{ else }}

            <ul class="plex-added-list list-unstyled">
              {{ range $items }}
                {{ $itemType := .String "type" }}
                {{ $typeClass := "item" }}
                {{ $typeTitle := "Item" }}
                {{ if eq $itemType "movie" }}{{ $typeClass = "movie" }}{{ $typeTitle = "Movie" }}
                {{ else if eq $itemType "episode" }}{{ $typeClass = "episode" }}{{ $typeTitle = "Episode" }}
                {{ else if eq $itemType "season" }}{{ $typeClass = "season" }}{{ $typeTitle = "Season" }}
                {{ else if eq $itemType "show" }}{{ $typeClass = "show" }}{{ $typeTitle = "Show" }}
                {{ end }}

                {{ $title := .String "title" }}
                {{ if eq $itemType "episode" }}
                  {{ $title = concat (.String "grandparentTitle") " — " (.String "title") }}
                {{ end }}

                {{ $thumbPath := .String "thumb" }}
                {{ if eq $itemType "episode" }}{{ $thumbPath = .String "grandparentThumb" }}{{ end }}
                {{ $thumbURL := "" }}
                {{ if ne $thumbPath "" }}
                  {{ $thumbURL = concat $baseURL $thumbPath "?X-Plex-Token=" $apiKey }}
                {{ end }}

                {{ $itemKey := .String "key" }}
                {{ $itemURL := concat $baseURL "/web/index.html#!/server/" $machineId "/details?key=" $itemKey }}

                {{ $addedAt := .String "addedAt" | parseRelativeTime "unix" }}

                <li class="plex-added-item">
                  {{ if ne $thumbURL "" }}
                    <img class="plex-added-poster" src="{{ $thumbURL | safeURL }}" alt="{{ $title }} poster" loading="lazy" />
                  {{ end }}
                  <div class="plex-added-body">
                    <div class="plex-added-head">
                      <a href="{{ $itemURL | safeURL }}" target="_blank" rel="noreferrer" class="text-truncate color-primary-if-not-visited">{{ $title }}</a>
                    </div>
                    <div class="size-h6 color-paragraph">
                      {{ if gt (.Int "year") 0 }}{{ .Int "year" }} · {{ end }}<span {{ $addedAt }}></span> ago
                    </div>
                  </div>
                </li>
              {{ end }}
            </ul>

          {{ end }}
        {{ end }}
      {{ else if or (eq $call.Response.StatusCode 401) (eq $call.Response.StatusCode 403) }}
        <p class="color-negative">Plex auth failed. Check API token.</p>
      {{ else }}
        <p class="color-negative">Failed to fetch recently added from Plex.</p>
      {{ end }}
    {{ end }}
