- type: custom-api
  title: Real-Debrid
  cache: 30s
  options:
    mock: "true"
  url: https://api.real-debrid.com/rest/1.0/user
  headers:
    Authorization: Bearer ${RD_API_KEY}
    Accept: application/json
  subrequests:
    active:
      url: https://api.real-debrid.com/rest/1.0/torrents
      headers:
        Authorization: Bearer ${RD_API_KEY}
        Accept: application/json
      parameters:
        filter: active
        limit: 10
  template: |
    {{ $mock := eq (.Options.StringOr "mock" "false") "false" }}
    {{ $active := .Subrequest "active" }}

    <style>
      .rd-summary {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .rd-stat {
        border: 1px solid var(--color-widget-content-border);
        border-radius: var(--border-radius);
        padding: 0.65rem 0.75rem;
        background: color-mix(in srgb, var(--color-background) 92%, transparent);
      }

      .rd-stat-label {
        font-size: var(--font-size-h6);
        color: var(--color-text-tertiary);
        margin-bottom: 0.2rem;
      }

      .rd-stat-value {
        font-size: var(--font-size-h3);
        color: var(--color-primary);
        line-height: 1.1;
      }

      .rd-list {
        display: grid;
        gap: 0.75rem;
      }

      .rd-item {
        border: 1px solid var(--color-widget-content-border);
        border-radius: var(--border-radius);
        padding: 0.55rem 0.65rem;
      }

      .rd-row-top,
      .rd-row-bottom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
      }

      .rd-row-top {
        margin-bottom: 0.45rem;
      }

      .rd-name {
        color: var(--color-primary);
        font-size: var(--font-size-title-dynamic);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .rd-pill {
        border: 1px solid var(--color-widget-content-border);
        border-radius: 999px;
        padding: 0.1rem 0.45rem;
        font-size: var(--font-size-h6);
        text-transform: uppercase;
      }

      .rd-state {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        border: 1px solid var(--color-widget-content-border);
        border-radius: 999px;
        padding: 0.12rem 0.5rem;
        font-size: var(--font-size-h6);
        text-transform: uppercase;
      }

      .rd-state-dot {
        width: 0.45rem;
        height: 0.45rem;
        border-radius: 999px;
        background: var(--color-text-tertiary);
      }

      .rd-state-active .rd-state-dot,
      .rd-state-uploading .rd-state-dot {
        background: var(--color-positive);
      }

      .rd-state-pending .rd-state-dot,
      .rd-state-magnet .rd-state-dot,
      .rd-state-waiting .rd-state-dot,
      .rd-state-compressing .rd-state-dot {
        background: var(--color-primary);
      }

      .rd-state-done .rd-state-dot {
        background: var(--color-text-base);
      }

      .rd-state-error .rd-state-dot,
      .rd-state-dead .rd-state-dot {
        background: var(--color-negative);
      }

      .rd-progress-track {
        background: color-mix(in srgb, var(--color-text-base) 18%, transparent);
        border-radius: 999px;
        height: 7px;
        overflow: hidden;
        margin-bottom: 0.45rem;
      }

      .rd-progress-fill {
        background: var(--color-positive);
        height: 100%;
        border-radius: 999px;
      }

      .rd-meta {
        color: var(--color-text-tertiary);
        font-size: var(--font-size-h6);
      }
    </style>

    {{ if $mock }}
      <div class="rd-summary">
        <div class="rd-stat">
          <div class="rd-stat-label">Active</div>
          <div class="rd-stat-value">4</div>
        </div>
        <div class="rd-stat">
          <div class="rd-stat-label">Premium Left</div>
          <div class="rd-stat-value">68d 4h</div>
        </div>
      </div>

      <div class="rd-list">
        <div class="rd-item">
          <div class="rd-row-top">
            <div class="rd-name">Silo.S02E03.2160p.WEB-DL.mkv</div>
            <span class="rd-state rd-state-active"><span class="rd-state-dot"></span><span>Downloading</span></span>
          </div>
          <div class="rd-progress-track"><div class="rd-progress-fill" style="width: 82%;"></div></div>
          <div class="rd-row-bottom rd-meta"><span>82%</span><span>6.2 MB/s</span></div>
        </div>

        <div class="rd-item">
          <div class="rd-row-top">
            <div class="rd-name">Dune.Part.Two.2024.1080p.BluRay.x265</div>
            <span class="rd-state rd-state-pending"><span class="rd-state-dot"></span><span>Queued</span></span>
          </div>
          <div class="rd-progress-track"><div class="rd-progress-fill" style="width: 34%;"></div></div>
          <div class="rd-row-bottom rd-meta"><span>34%</span><span>--</span></div>
        </div>

        <div class="rd-item">
          <div class="rd-row-top">
            <div class="rd-name">Severance.S01.COMPLETE.1080p</div>
            <span class="rd-state rd-state-active"><span class="rd-state-dot"></span><span>Downloading</span></span>
          </div>
          <div class="rd-progress-track"><div class="rd-progress-fill" style="width: 61%;"></div></div>
          <div class="rd-row-bottom rd-meta"><span>61%</span><span>2.8 MB/s</span></div>
        </div>

        <div class="rd-item">
          <div class="rd-row-top">
            <div class="rd-name">The.Last.of.Us.S02E01.4K</div>
            <span class="rd-state rd-state-magnet"><span class="rd-state-dot"></span><span>Magnet</span></span>
          </div>
          <div class="rd-progress-track"><div class="rd-progress-fill" style="width: 9%;"></div></div>
          <div class="rd-row-bottom rd-meta"><span>9%</span><span>--</span></div>
        </div>
      </div>
    {{ else if and (eq .Response.StatusCode 200) (eq $active.Response.StatusCode 200) }}
      {{ $premiumSeconds := .JSON.Int "premium" }}
      {{ $days := div $premiumSeconds 86400 }}
      {{ $hours := div (mod $premiumSeconds 86400) 3600 }}
      {{ $activeList := $active.JSON.Array "" }}

      <div class="rd-summary">
        <div class="rd-stat">
          <div class="rd-stat-label">Active</div>
          <div class="rd-stat-value">{{ len $activeList }}</div>
        </div>
        <div class="rd-stat">
          <div class="rd-stat-label">Premium Left</div>
          <div class="rd-stat-value">{{ $days }}d {{ $hours }}h</div>
        </div>
      </div>

      {{ if eq (len $activeList) 0 }}
        <p>No active downloads.</p>
      {{ else }}
        <ul class="rd-list list-unstyled">
          {{ range $activeList }}
            {{ $progress := .Int "progress" }}
            {{ $statusRaw := .String "status" }}
            {{ $statusText := "Unknown" }}
            {{ $statusClass := "pending" }}
            {{ if eq $statusRaw "downloading" }}
              {{ $statusText = "Downloading" }}
              {{ $statusClass = "active" }}
            {{ else if eq $statusRaw "queued" }}
              {{ $statusText = "Queued" }}
              {{ $statusClass = "pending" }}
            {{ else if eq $statusRaw "magnet_conversion" }}
              {{ $statusText = "Magnet" }}
              {{ $statusClass = "magnet" }}
            {{ else if eq $statusRaw "waiting_files_selection" }}
              {{ $statusText = "Selecting" }}
              {{ $statusClass = "waiting" }}
            {{ else if eq $statusRaw "compressing" }}
              {{ $statusText = "Compressing" }}
              {{ $statusClass = "compressing" }}
            {{ else if eq $statusRaw "uploading" }}
              {{ $statusText = "Uploading" }}
              {{ $statusClass = "uploading" }}
            {{ else if eq $statusRaw "downloaded" }}
              {{ $statusText = "Done" }}
              {{ $statusClass = "done" }}
            {{ else if or (eq $statusRaw "error") (eq $statusRaw "magnet_error") }}
              {{ $statusText = "Error" }}
              {{ $statusClass = "error" }}
            {{ else if eq $statusRaw "dead" }}
              {{ $statusText = "Dead" }}
              {{ $statusClass = "dead" }}
            {{ end }}
            <li class="rd-item">
              <div class="rd-row-top">
                <div class="rd-name">{{ .String "filename" }}</div>
                <span class="rd-state rd-state-{{ $statusClass }}"><span class="rd-state-dot"></span><span>{{ $statusText }}</span></span>
              </div>
              <div class="rd-progress-track">
                <div class="rd-progress-fill" style="width: {{ $progress }}%;"></div>
              </div>
              <div class="rd-row-bottom rd-meta">
                <span>{{ $progress }}%</span>
                {{ $speed := .Int "speed" }}
                {{ if gt $speed 0 }}
                  <span>{{ printf "%.1f MB/s" (div (.Float "speed") 1000000.0) }}</span>
                {{ else }}
                  <span>--</span>
                {{ end }}
              </div>
            </li>
          {{ end }}
        </ul>
      {{ end }}
    {{ else }}
      {{ if or (eq .Response.StatusCode 401) (eq .Response.StatusCode 403) (eq $active.Response.StatusCode 401) (eq $active.Response.StatusCode 403) }}
        <p class="color-negative">Real-Debrid auth failed. Check RD_API_KEY.</p>
      {{ else if or (eq .Response.StatusCode 429) (eq $active.Response.StatusCode 429) }}
        <p class="color-negative">Real-Debrid rate limit reached (429).</p>
      {{ else }}
        <p class="color-negative">Failed to fetch Real-Debrid data.</p>
      {{ end }}
    {{ end }}
