- type: custom-api
  title: Bookmarks
  title-url: https://linkwarden.corvus-corax.synology.me/dashboard
  url: https://linkwarden.corvus-corax.synology.me/api/v1/links?pinnedOnly=true&ass
  headers:
    Authorization: Bearer ${LINKWARDEN_TOKEN}
    Accept: application/json
    Cache-Control: no-cache
  options:
    # Icon overrides - use full URL or domain as key, icon path as value
    # Full URL is checked first, then domain fallback
    "https://account.proton.me/mail": "https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/proton-mail.svg"
    "https://account.proton.me/calendar": "https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/proton-calendar.svg"
    "https://github.com/": "https://cdn.jsdelivr.net/gh/selfhst/icons/svg/github-light.svg"
  template: |
    {{ if .Response.StatusCode }}
      {{ if eq .Response.StatusCode 200 }}
        {{ $hasItems := false }}
        {{ $allItems := .JSON.Array "response" }}
        {{ if eq (len $allItems) 0 }}
          {{ $allItems = .JSON.Array "data.links" }}
        {{ end }}
        {{ if eq (len $allItems) 0 }}
          {{ $allItems = .JSON.Array "links" }}
        {{ end }}
        {{ if eq (len $allItems) 0 }}
          {{ $allItems = .JSON.Array "pinnedLinks" }}
        {{ end }}
        
        <!-- Square cards for Slot1-Slot10 tags -->
        <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 20px;">
          {{ $slots := "Slot1,Slot2,Slot3,Slot4,Slot5,Slot6,Slot7,Slot8,Slot9,Slot10" }}
          {{ range $allItems }}
            {{ $itemSlot := "" }}
              {{ range .Array "tags" }}
                {{ $tagName := .String "name" }}
                {{ if or (eq $tagName "Slot1") (eq $tagName "Slot2") (eq $tagName "Slot3") (eq $tagName "Slot4") (eq $tagName "Slot5") (eq $tagName "Slot6") (eq $tagName "Slot7") (eq $tagName "Slot8") (eq $tagName "Slot9") (eq $tagName "Slot10") }}
                  {{ $itemSlot = $tagName }}
                {{ end }}
              {{ end }}
              {{ if $itemSlot }}
                {{ $hasItems = true }}
                {{ $url := .String "url" }}
                {{ $domain := replaceMatches "^https?://([^/]+).*$" "$1" $url }}
                
                <!-- Check for icon override - try full URL first, then domain -->
                {{ $customIcon := $.Options.StringOr $url "" }}
                {{ if not $customIcon }}
                  {{ $customIcon = $.Options.StringOr $domain "" }}
                {{ end }}
                
                <a href="{{ $url }}" 
                   data-slot="{{ $itemSlot }}"
                   style="display: flex; align-items: center; justify-content: center; width: 80px; height: 80px; border-radius: 8px; background: rgba(255,255,255,0.05); text-decoration: none; transition: all 0.2s; order: {{ if eq $itemSlot "Slot1" }}1{{ else if eq $itemSlot "Slot2" }}2{{ else if eq $itemSlot "Slot3" }}3{{ else if eq $itemSlot "Slot4" }}4{{ else if eq $itemSlot "Slot5" }}5{{ else if eq $itemSlot "Slot6" }}6{{ else if eq $itemSlot "Slot7" }}7{{ else if eq $itemSlot "Slot8" }}8{{ else if eq $itemSlot "Slot9" }}9{{ else }}10{{ end }};"
                   title="{{ .String "name" }}"
                   onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='scale(1.05)'"
                   onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.transform='scale(1)'">
                   {{ if $customIcon }}
                    <img src="{{ $customIcon }}" 
                         alt="" 
                         width="32" 
                         height="32"
                          />
                  {{ else }}
                    <img src="https://twenty-icons.com/{{ $domain }}" 
                         alt="" 
                         width="32" 
                         height="32" />
                  {{ end }}
                </a>
              {{ end }}
          {{ end }}
        </div>
        
        <!-- List for remaining pinned items without slot tags, grouped by collection -->
        {{ $sortedItems := sortByString "collection.name" "asc" $allItems }}
        {{ $collectionCount := 0.0 }}
        {{ $countedCollection := "" }}
        {{ range $sortedItems }}
          {{ if .Array "pinnedBy" }}
            {{ $hasSlotTag := false }}
              {{ range .Array "tags" }}
                {{ if or (eq (.String "name") "Slot1") (eq (.String "name") "Slot2") (eq (.String "name") "Slot3") (eq (.String "name") "Slot4") (eq (.String "name") "Slot5") (eq (.String "name") "Slot6") (eq (.String "name") "Slot7") (eq (.String "name") "Slot8") (eq (.String "name") "Slot9") (eq (.String "name") "Slot10") }}
                  {{ $hasSlotTag = true }}
                {{ end }}
              {{ end }}
            {{ if not $hasSlotTag }}
              {{ $collection := .String "collection.name" }}
              {{ if not $collection }}
                {{ $collection = "Uncategorized" }}
              {{ end }}
              {{ if ne $collection $countedCollection }}
                {{ $collectionCount = add $collectionCount 1.0 }}
                {{ $countedCollection = $collection }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
        {{ $columnCount := toInt $collectionCount }}
        {{ if eq $columnCount 0 }}
          {{ $columnCount = 1 }}
        {{ end }}
        <div style="display: grid; grid-template-columns: repeat({{ $columnCount }}, minmax(0, 1fr)); gap: 1.5rem 2rem;">
        {{ $lastCollection := "" }}
        {{ $openCollection := false }}
        {{ range $sortedItems }}
          {{ if .Array "pinnedBy" }}
            {{ $hasSlotTag := false }}
              {{ range .Array "tags" }}
                {{ if or (eq (.String "name") "Slot1") (eq (.String "name") "Slot2") (eq (.String "name") "Slot3") (eq (.String "name") "Slot4") (eq (.String "name") "Slot5") (eq (.String "name") "Slot6") (eq (.String "name") "Slot7") (eq (.String "name") "Slot8") (eq (.String "name") "Slot9") (eq (.String "name") "Slot10") }}
                  {{ $hasSlotTag = true }}
                {{ end }}
              {{ end }}
            {{ if not $hasSlotTag }}
              {{ $hasItems = true }}
              {{ $collection := .String "collection.name" }}
              {{ if not $collection }}
                {{ $collection = "Uncategorized" }}
              {{ end }}
              {{ if ne $collection $lastCollection }}
                {{ if $openCollection }}
                  </div>
                {{ end }}
                {{ $lastCollection = $collection }}
                {{ $openCollection = true }}
                <div style="display: flex; flex-direction: column; gap: 0.35rem;">
                  <div class="size-h6" style="margin-bottom: 0.25rem; opacity: 0.7;">{{ $collection }}</div>
              {{ end }}
              {{ $url := .String "url" }}
              {{ $name := .String "name" }}
              {{ if not $name }}
                {{ $name = .String "description" }}
              {{ end }}
              <a href="{{ $url }}" class="size-h4 color-highlight" title="{{ $name }}">{{ $name }}</a>
            {{ end }}
          {{ end }}
        {{ end }}
        {{ if $openCollection }}
          </div>
        {{ end }}
        </div>
        
        {{ if not $hasItems }}
          <p class="color-subdue">No pinned bookmarks found. Pin some links in Linkwarden to see them here!</p>
        {{ end }}


      {{ else }}
        <p class="color-negative">⚠️ LINKWARDEN_TOKEN not configured. Add token to Glance environment.</p>
      {{ end }}
    {{ else }}
      <p class="color-negative">⚠️ Failed to connect to Linkwarden. Check token configuration.</p>
    {{ end }}
