- type: custom-api
  title: Containers
  title-url: https://komodo.corvus-corax.synology.me/containers
  method: POST
  cache: 5m
  allow-insecure: false
  url: https://komodo.corvus-corax.synology.me/read
  body-type: json
  body:
    type: ListAllDockerContainers
    params: {}
  headers:
    Content-Type: application/json
    X-Api-Key: ${KOMODO_API_KEY}
    X-Api-Secret: ${KOMODO_API_SECRET}
  options:
    base-url: https://komodo.corvus-corax.synology.me
  template: |
    {{ $urlBase := .Options.StringOr "base-url" "" }}

    {{ $containers := .JSON.Array "" }}
    {{ $total := len $containers }}
    {{ $running := 0 }}

    {{ range $containers }}
      {{ if eq (.String "state") "running" }}{{ $running = add $running 1 }}{{ end }}
    {{ end }}

    <div class="flex gap-10 margin-bottom-10">
      <span><strong>{{ $running }}</strong>/{{ $total }} running</span>
    </div>

    <div class="collapsible-container" data-collapse-after="10">
      {{ range $containers }}
        {{ $state := .String "state" }}
        {{ $name := .String "name" }}
        {{ $isRunning := eq $state "running" }}
        
        <div class="container-row">
          <span class="container-status {{ if $isRunning }}status-running{{ else }}status-stopped{{ end }}"></span>
          <div class="container-name min-width-0">
            {{ $cpuPerc := .String "stats.cpu_perc" }}
            {{ $memPerc := .String "stats.mem_perc" }}
            {{ $hasStats := and (.Exists "stats") (ne $cpuPerc "") (ne $cpuPerc "--") }}
            {{ if $hasStats }}
              <div data-popover-type="html" data-popover-position="above">
                <div data-popover-html>
                  <div class="flex">
                    <div class="size-h5">CPU</div>
                    <div class="value-separator"></div>
                    <div class="color-highlight text-very-compact">{{ $cpuPerc }}</div>
                  </div>
                  {{ if and (ne $memPerc "") (ne $memPerc "--") }}
                  <div class="flex">
                    <div class="size-h5">MEM</div>
                    <div class="value-separator"></div>
                    <div class="color-highlight text-very-compact">{{ $memPerc }}</div>
                  </div>
                  {{ end }}
                </div>
                <a class="color-highlight text-truncate" href="{{ concat $urlBase "/servers/" (.String "server_id") "/container/" $name }}" target="_blank" rel="noreferrer">{{ $name }}</a>
              </div>
            {{ else }}
              <a class="color-highlight text-truncate" href="{{ concat $urlBase "/servers/" (.String "server_id") "/container/" $name }}" target="_blank" rel="noreferrer">{{ $name }}</a>
            {{ end }}
            {{ if .Exists "ports" }}
              {{ $ports := .Array "ports" }}
              {{ if gt (len $ports) 0 }}
                <span class="size-h5 color-subdue margin-left-5">
                  {{ $first := true }}
                  {{ range $ports }}
                    {{ $publicPort := .Int "PublicPort" }}
                    {{ if and (.Exists "PublicPort") (gt $publicPort 0) }}
                      {{ if not $first }} â€¢ {{ end }}{{ $publicPort }}:{{ .Int "PrivatePort" }}
                      {{ $first = false }}
                    {{ end }}
                  {{ end }}
                </span>
              {{ end }}
            {{ end }}
          </div>
        </div>
      {{ end }}
    </div>
