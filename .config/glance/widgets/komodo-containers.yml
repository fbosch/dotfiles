- type: custom-api
  title: Containers
  title-url: https://komodo.corvus-corax.synology.me/containers
  method: POST
  cache: 5m
  allow-insecure: false
  url: ${KOMODO_URL}/read
  body-type: json
  body:
    type: ListAllDockerContainers
    params: {}
  headers:
    Content-Type: application/json
    X-Api-Key: ${KOMODO_API_KEY}
    X-Api-Secret: ${KOMODO_API_SECRET}
  options:
    base-url: ${KOMODO_URL}
  template: |
    {{ $urlBase := .Options.StringOr "base-url" "" }}

    <link rel="stylesheet" href="/assets/css/komodo-containers.css">

    {{ $containers := .JSON.Array "" }}
    {{ $total := len $containers }}
    {{ $running := 0 }}

    {{ range $containers }}
      {{ if eq (.String "state") "running" }}{{ $running = add $running 1 }}{{ end }}
    {{ end }}

    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
      <span><strong>{{ $running }}</strong>/{{ $total }} running</span>
    </div>

    <div class="collapsible-container" data-collapse-after="10">
      {{ range $containers }}
        {{ $state := .String "state" }}
        {{ $name := .String "name" }}
        {{ $isRunning := eq $state "running" }}
        
        <div class="container-row">
          <span class="container-status {{ if $isRunning }}status-running{{ else }}status-stopped{{ end }}"></span>
          <div class="container-name">
            <a class="color-highlight" href="{{ concat $urlBase "/containers/" (.String "id") }}" target="_blank">
              {{ $name }}
            </a>
            {{ if .Exists "ports" }}
              {{ $ports := .Array "ports" }}
              {{ if gt (len $ports) 0 }}
                <span style="font-size: 0.875em; opacity: 0.6; margin-left: 0.5rem;">
                  {{ $first := true }}
                  {{ range $ports }}
                    {{ $publicPort := .Int "PublicPort" }}
                    {{ if and (.Exists "PublicPort") (gt $publicPort 0) }}
                      {{ if not $first }} â€¢ {{ end }}{{ $publicPort }}:{{ .Int "PrivatePort" }}
                      {{ $first = false }}
                    {{ end }}
                  {{ end }}
                </span>
              {{ end }}
            {{ end }}
          </div>
          {{ if $isRunning }}
            <div class="container-stats">
              {{ $cpuPerc := .String "stats.cpu_perc" }}
              {{ $memPerc := .String "stats.mem_perc" }}
              {{ if ne $cpuPerc "" }}<span>CPU: {{ $cpuPerc }}</span>{{ end }}
              {{ if ne $memPerc "" }}<span>MEM: {{ $memPerc }}</span>{{ end }}
            </div>
          {{ end }}
        </div>
      {{ end }}
    </div>
