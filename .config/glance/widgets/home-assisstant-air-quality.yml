- type: custom-api
  title: Indoor Air Quality
  cache: 10m
  url: https://ha.corvus-corax.synology.me/api/states
  headers:
    Authorization: "Bearer ${HASS_API_KEY}"
    Content-Type: "application/json"
  template: |
    {{ if eq .Response.StatusCode 200 }}
      <style>
        .aq-good { color: var(--color-positive); }
        .aq-yellow {
          color: color-mix(
            in oklab,
            var(--color-positive) 58%,
            var(--color-negative) 42%
          );
        }
        .aq-orange {
          color: color-mix(
            in oklab,
            var(--color-positive) 30%,
            var(--color-negative) 70%
          );
        }
        .aq-red { color: var(--color-negative); }
      </style>
      {{ $shouldVentilate := false }}
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
        {{ range .JSON.Array "" }}
          {{ $id := .String "entity_id" }}
          {{ $state := .String "state" }}
          {{ $friendly := replaceMatches "^Air Quality Monitor\\s+" "" (.String "attributes.friendly_name") }}
          {{ if and (or
                        (eq $id "sensor.air_quality_monitor_carbon_dioxide")
                        (eq $id "sensor.air_quality_monitor_volatile_organic_compounds")
                        (eq $id "sensor.air_quality_monitor_formaldehyde")
                        (eq $id "sensor.air_quality_monitor_humidity")
                    )
                    (ne $state "unavailable")
                    (ne $state "unknown")
          }}
            {{ $value := .Float "state" }}
            {{ $valueClass := "aq-red" }}
            {{ if eq $id "sensor.air_quality_monitor_carbon_dioxide" }}
              {{ if le $value 800.0 }}
                {{ $valueClass = "aq-good" }}
              {{ else if le $value 1000.0 }}
                {{ $valueClass = "aq-yellow" }}
              {{ else if le $value 1500.0 }}
                {{ $valueClass = "aq-orange" }}
              {{ else }}
                {{ $valueClass = "aq-red" }}
              {{ end }}
            {{ else if eq $id "sensor.air_quality_monitor_humidity" }}
              {{ if and (ge $value 40.0) (le $value 60.0) }}
                {{ $valueClass = "aq-good" }}
              {{ else if and (ge $value 30.0) (lt $value 40.0) }}
                {{ $valueClass = "aq-yellow" }}
              {{ else if and (gt $value 60.0) (le $value 70.0) }}
                {{ $valueClass = "aq-orange" }}
              {{ else }}
                {{ $valueClass = "aq-red" }}
              {{ end }}
            {{ else if eq $id "sensor.air_quality_monitor_volatile_organic_compounds" }}
              {{ if lt $value 0.3 }}
                {{ $valueClass = "aq-good" }}
              {{ else if lt $value 0.5 }}
                {{ $valueClass = "aq-yellow" }}
              {{ else if lt $value 1.0 }}
                {{ $valueClass = "aq-orange" }}
              {{ else }}
                {{ $valueClass = "aq-red" }}
              {{ end }}
            {{ else if eq $id "sensor.air_quality_monitor_formaldehyde" }}
              {{ if lt $value 0.03 }}
                {{ $valueClass = "aq-good" }}
              {{ else if lt $value 0.08 }}
                {{ $valueClass = "aq-yellow" }}
              {{ else if lt $value 0.10 }}
                {{ $valueClass = "aq-orange" }}
              {{ else }}
                {{ $valueClass = "aq-red" }}
              {{ end }}
            {{ end }}
            {{ if or (eq $valueClass "aq-orange") (eq $valueClass "aq-red") }}
              {{ $shouldVentilate = true }}
            {{ end }}
            <div class="background-faint radius-8" style="padding: 6px 10px; text-align: center;">
              <div class="size-h3 {{ $valueClass }}" style="line-height: 1.2;">
                {{ $state }}{{ .String "attributes.unit_of_measurement" }}
              </div>
              <div class="size-h6 color-subdue" style="line-height: 1.2;">
                {{ $friendly }}
              </div>
            </div>
          {{ end }}
        {{ end }}
      </div>
      {{ if $shouldVentilate }}
        <div class="color-negative size-h5" style="margin-top: 8px; text-align: center;">
          You should ventilate
        </div>
      {{ end }}
    {{ else }}
      <div style="text-align: center;" class="color-negative size-h4">
        Error: {{ .Response.StatusCode }} - {{ .Response.Status }}
      </div>
    {{ end }}
