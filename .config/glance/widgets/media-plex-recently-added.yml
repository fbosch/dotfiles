- type: custom-api
  title: Plex Recently Added
  cache: 10m
  options:
    base-url: "https://plex.corvus-corax.synology.me"
    api-key: ${PLEX_TOKEN}
    limit: 6
  template: |
    {{ $baseURL := .Options.StringOr "base-url" "" }}
    {{ $apiKey := .Options.StringOr "api-key" "" }}
    {{ $limit := .Options.IntOr "limit" 6 }}

    {{ if or (eq $baseURL "") (eq $apiKey "") }}
      <p class="color-negative">Set Plex base URL and API token in this widget options block.</p>
    {{ else }}
      <link rel="stylesheet" href="/assets/css/plex.css">

      {{ $call := newRequest (concat $baseURL "/library/recentlyAdded")
        | withHeader "Accept" "application/json"
        | withHeader "X-Plex-Token" $apiKey
        | withParameter "X-Plex-Container-Start" "0"
        | withParameter "X-Plex-Container-Size" (printf "%d" $limit)
        | getResponse }}

      {{ if eq $call.Response.StatusCode 200 }}
        {{ $items := $call.JSON.Array "MediaContainer.Metadata" }}
        {{ if eq (len $items) 0 }}
          <p>No recent additions.</p>
        {{ else }}
          <ul class="plex-added-list list-unstyled">
            {{ range $items }}
              {{ $itemType := .String "type" }}
              {{ $label := "Item" }}
              {{ if eq $itemType "movie" }}
                {{ $label = "Movie" }}
              {{ else if eq $itemType "episode" }}
                {{ $label = "Episode" }}
              {{ else if eq $itemType "season" }}
                {{ $label = "Season" }}
              {{ else if eq $itemType "show" }}
                {{ $label = "Show" }}
              {{ end }}

              {{ $title := .String "title" }}
              {{ if eq $itemType "episode" }}
                {{ $title = concat (.String "grandparentTitle") " - " (.String "title") }}
              {{ end }}

              {{ $thumbPath := .String "thumb" }}
              {{ if eq $itemType "episode" }}
                {{ $thumbPath = .String "grandparentThumb" }}
              {{ end }}
              {{ $thumbURL := "" }}
              {{ if ne $thumbPath "" }}
                {{ $thumbURL = concat $baseURL $thumbPath "?X-Plex-Token=" $apiKey }}
              {{ end }}

              {{ $addedAt := .String "addedAt" | parseRelativeTime "unix" }}

              <li class="plex-added-item">
                {{ if ne $thumbURL "" }}
                  <img class="plex-added-poster" src="{{ $thumbURL | safeURL }}" alt="{{ $title }} poster" loading="lazy" />
                {{ end }}
                <div class="plex-added-body">
                  <div class="plex-added-head">
                    <div class="text-truncate color-highlight">{{ $title }}</div>
                    <span class="plex-added-type">{{ $label }}</span>
                  </div>
                  <div class="size-h6 color-paragraph">
                    {{ if gt (.Int "year") 0 }}{{ .Int "year" }} Â· {{ end }}
                    <span {{ $addedAt }}></span>
                    <span> ago</span>
                  </div>
                </div>
              </li>
            {{ end }}
          </ul>
        {{ end }}
      {{ else if or (eq $call.Response.StatusCode 401) (eq $call.Response.StatusCode 403) }}
        <p class="color-negative">Plex auth failed. Check API token.</p>
      {{ else }}
        <p class="color-negative">Failed to fetch recently added from Plex.</p>
      {{ end }}
    {{ end }}
